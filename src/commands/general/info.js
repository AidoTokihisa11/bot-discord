import { SlashCommandBuilder, EmbedBuilder, ActionRowBuilder, ButtonBuilder, ButtonStyle } from 'discord.js';

import AccessRestriction from '../../utils/AccessRestriction.js';
export default {
    data: new SlashCommandBuilder()
        .setName('info')
        .setDescription('üìã Afficher les informations d√©taill√©es d\'un utilisateur')
        .addUserOption(option =>
            option.setName('user')
                .setDescription('Utilisateur √† analyser')
                .setRequired(false)
        ),

    async execute(interaction) {
        // === V√âRIFICATION D'ACC√àS GLOBALE ===
        const accessRestriction = new AccessRestriction();
        const hasAccess = await accessRestriction.checkAccess(interaction);
        if (!hasAccess) {
            return; // Acc√®s refus√©, message d√©j√† envoy√©
        }


        await interaction.deferReply();

        try {
            const targetUser = interaction.options.getUser('user') || interaction.user;
            const member = await interaction.guild.members.fetch(targetUser.id).catch(() => null);
            
            if (!member) {
                const errorEmbed = new EmbedBuilder()
                    .setTitle('‚ùå **Utilisateur introuvable**')
                    .setDescription('Cet utilisateur n\'est pas membre de ce serveur.')
                    .setColor('#e74c3c');
                    
                return await interaction.editReply({ embeds: [errorEmbed] });
            }

            // Calculer les statistiques
            const userStats = await this.calculateUserStats(member, interaction.client.db);
            
            const embed = new EmbedBuilder()
                .setTitle(`üìã **PROFIL UTILISATEUR D√âTAILL√â**`)
                .setDescription(`**Analyse compl√®te de ${member.user.tag}**`)
                .addFields(
                    {
                        name: 'üë§ **Informations g√©n√©rales**',
                        value: `**Nom :** ${member.user.tag}\n**ID :** \`${member.user.id}\`\n**Mention :** ${member}\n**Surnom :** ${member.nickname || 'Aucun'}`,
                        inline: true
                    },
                    {
                        name: 'üìÖ **Dates importantes**',
                        value: `**Compte cr√©√© :** <t:${Math.floor(member.user.createdTimestamp / 1000)}:R>\n**Rejoint le serveur :** <t:${Math.floor(member.joinedTimestamp / 1000)}:R>\n**Booster depuis :** ${member.premiumSince ? `<t:${Math.floor(member.premiumSince.getTime() / 1000)}:R>` : 'Non booster'}`,
                        inline: true
                    },
                    {
                        name: 'üé≠ **Statut et pr√©sence**',
                        value: `**Statut :** ${this.getStatusEmoji(member.presence?.status)} ${member.presence?.status || 'offline'}\n**Activit√© :** ${this.getActivity(member.presence)}\n**Sur mobile :** ${member.presence?.clientStatus?.mobile ? 'üì± Oui' : 'üíª Non'}`,
                        inline: true
                    },
                    {
                        name: `üè∑Ô∏è **R√¥les (${member.roles.cache.size - 1})**`,
                        value: member.roles.cache.size > 1 
                            ? member.roles.cache
                                .filter(role => role.id !== interaction.guild.id)
                                .sort((a, b) => b.position - a.position)
                                .slice(0, 10)
                                .map(role => `${role}`)
                                .join(' ') + (member.roles.cache.size > 11 ? `\n*... et ${member.roles.cache.size - 11} autre(s)*` : '')
                            : 'Aucun r√¥le',
                        inline: false
                    },
                    {
                        name: 'üõ°Ô∏è **Permissions cl√©s**',
                        value: this.getKeyPermissions(member),
                        inline: true
                    },
                    {
                        name: 'üìä **Statistiques**',
                        value: `**Niveau de confiance :** ${userStats.trustLevel}\n**Score d'activit√© :** ${userStats.activityScore}/100\n**Ant√©c√©dents :** ${userStats.moderationHistory}`,
                        inline: true
                    },
                    {
                        name: 'üîç **Analyse comportementale**',
                        value: `**Profil :** ${userStats.behaviorProfile}\n**Risque :** ${userStats.riskLevel}\n**Recommandation :** ${userStats.recommendation}`,
                        inline: true
                    }
                )
                .setColor(member.displayHexColor || '#3498db')
                .setThumbnail(member.user.displayAvatarURL({ size: 256 }))
                .setImage('https://i.imgur.com/s74nSIc.png')
                .setTimestamp()
                .setFooter({ 
                    text: `Analyse g√©n√©r√© par Team7 Bot ‚Ä¢ Demand√© par ${interaction.user.tag}`,
                    iconURL: interaction.user.displayAvatarURL()
                });

            const actionRow = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId(`user_moderation_${targetUser.id}`)
                        .setLabel('üõ°Ô∏è Historique mod√©ration')
                        .setStyle(ButtonStyle.Secondary),
                    new ButtonBuilder()
                        .setCustomId(`user_permissions_${targetUser.id}`)
                        .setLabel('üîê Permissions d√©taill√©es')
                        .setStyle(ButtonStyle.Primary),
                    new ButtonBuilder()
                        .setCustomId(`user_activity_${targetUser.id}`)
                        .setLabel('üìà Activit√© d√©taill√©e')
                        .setStyle(ButtonStyle.Success),
                    new ButtonBuilder()
                        .setCustomId(`user_refresh_${targetUser.id}`)
                        .setLabel('üîÑ Actualiser')
                        .setStyle(ButtonStyle.Secondary)
                );

            await interaction.editReply({
                embeds: [embed],
                components: [actionRow]
            });

        } catch (error) {
            console.error('Erreur lors de la r√©cup√©ration des informations:', error);
            
            const errorEmbed = new EmbedBuilder()
                .setTitle('‚ùå **Erreur**')
                .setDescription('Une erreur est survenue lors de la r√©cup√©ration des informations.')
                .setColor('#e74c3c');
                
            await interaction.editReply({ embeds: [errorEmbed] });
        }
    },

    async calculateUserStats(member, database) {
        const stats = {
            trustLevel: 'Nouveau',
            activityScore: 50,
            moderationHistory: 'Aucun',
            behaviorProfile: 'Standard',
            riskLevel: 'üü¢ Faible',
            recommendation: 'Aucune action requise'
        };

        try {
            // Calculer le niveau de confiance bas√© sur l'anciennet√©
            const accountAge = Date.now() - member.user.createdTimestamp;
            const guildAge = Date.now() - member.joinedTimestamp;
            
            if (accountAge > 365 * 24 * 60 * 60 * 1000) { // Plus d'1 an
                stats.trustLevel = 'Exp√©riment√©';
                stats.activityScore += 20;
            } else if (accountAge > 90 * 24 * 60 * 60 * 1000) { // Plus de 3 mois
                stats.trustLevel = 'Confirm√©';
                stats.activityScore += 10;
            }

            // V√©rifier l'historique de mod√©ration
            if (database && database.getUserHistory) {
                const history = await database.getUserHistory(member.user.id);
                if (history && history.length > 0) {
                    const warnings = history.filter(h => h.type === 'warn').length;
                    const serious = history.filter(h => ['kick', 'ban'].includes(h.type)).length;
                    
                    if (serious > 0) {
                        stats.moderationHistory = `${serious} sanction(s) grave(s)`;
                        stats.riskLevel = 'üî¥ √âlev√©';
                        stats.recommendation = 'Surveillance recommand√©e';
                        stats.activityScore -= 30;
                    } else if (warnings > 2) {
                        stats.moderationHistory = `${warnings} avertissement(s)`;
                        stats.riskLevel = 'üü° Mod√©r√©';
                        stats.recommendation = 'Attention requise';
                        stats.activityScore -= 15;
                    } else if (warnings > 0) {
                        stats.moderationHistory = `${warnings} avertissement(s) mineur(s)`;
                        stats.activityScore -= 5;
                    }
                }
            }

            // Analyser les r√¥les et permissions
            if (member.permissions.has('Administrator')) {
                stats.behaviorProfile = 'Administrateur';
                stats.trustLevel = 'Administrateur';
            } else if (member.permissions.has('ModerateMembers')) {
                stats.behaviorProfile = 'Mod√©rateur';
                stats.trustLevel = 'Staff';
            } else if (member.premiumSince) {
                stats.behaviorProfile = 'Booster loyal';
                stats.activityScore += 15;
            }

            // S'assurer que le score reste dans les limites
            stats.activityScore = Math.max(0, Math.min(100, stats.activityScore));

        } catch (error) {
            console.error('Erreur lors du calcul des statistiques:', error);
        }

        return stats;
    },

    getStatusEmoji(status) {
        const emojis = {
            'online': 'üü¢',
            'idle': 'üü°',
            'dnd': 'üî¥',
            'offline': '‚ö´'
        };
        return emojis[status] || '‚ùì';
    },

    getActivity(presence) {
        if (!presence?.activities?.length) return 'Aucune activit√©';
        
        const activity = presence.activities[0];
        const types = {
            0: 'üéÆ Joue √†',
            1: 'üé• Stream',
            2: 'üéµ √âcoute',
            3: 'üì∫ Regarde',
            5: 'üèÜ En comp√©tition'
        };
        
        return `${types[activity.type] || 'üì±'} ${activity.name}`;
    },

    getKeyPermissions(member) {
        const keyPerms = [
            ['Administrator', 'üëë Administrateur'],
            ['ManageGuild', '‚öôÔ∏è G√©rer le serveur'],
            ['ModerateMembers', 'üõ°Ô∏è Mod√©rer les membres'],
            ['ManageChannels', 'üìù G√©rer les salons'],
            ['ManageRoles', 'üè∑Ô∏è G√©rer les r√¥les'],
            ['KickMembers', 'üë¢ Expulser'],
            ['BanMembers', 'üî® Bannir']
        ];

        const userPerms = keyPerms
            .filter(([perm]) => member.permissions.has(perm))
            .map(([, display]) => display);

        return userPerms.length > 0 
            ? userPerms.slice(0, 3).join('\n') + (userPerms.length > 3 ? `\n*... et ${userPerms.length - 3} autre(s)*` : '')
            : 'Permissions de base';
    }
};
